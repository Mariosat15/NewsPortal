---
globs: app/api/**,lib/actions/**,apps/admin/app/api/**,apps/admin/lib/actions/**
description: API routes and server actions rules for ChartVolt
---

# API Routes & Server Actions â€” ChartVolt

## ğŸ—ï¸ Architecture Overview

- **Next.js API Routes:** `app/api/**/route.ts` â€” RESTful endpoints (GET/POST/PUT/DELETE).
- **Server Actions:** `lib/actions/**/*.actions.ts` â€” Called directly from React components via `"use server"`.
- **Admin API:** `apps/admin/app/api/**/route.ts` â€” Separate admin endpoints (different auth).
- **Admin Actions:** `apps/admin/lib/actions/**/*.actions.ts` â€” Admin-side server actions.
- **Standalone API:** `api-server/` â€” Express server for external integrations.

## ğŸ“ Server Action Rules

### Return Pattern (CRITICAL)

Server actions **MUST** return a result object â€” **never throw errors**.

```typescript
// âœ… CORRECT â€” always return
return { success: false, error: "Market is closed. Trading resumes Sunday 22:00 UTC." };
return { success: true, message: "Order placed successfully", data: order };

// âŒ WRONG â€” thrown errors are stripped in production builds
throw new Error("Market is closed");
```

// Reason: Next.js strips Error.message in production Server Component renders.

### Structure

1. Validate inputs early â€” return error if invalid.
2. `await connectToDatabase()` â€” always connect before any DB operation.
3. Authenticate â€” verify the user session.
4. Run business logic guards (market hours, restrictions, margin checks).
5. Perform the operation inside a try/catch.
6. Return `{ success, message/error, data? }`.
7. Call `revalidatePath()` if the mutation affects a rendered page.

### Naming

- Files: `kebab-case.actions.ts` (e.g., `order.actions.ts`, `competition.actions.ts`).
- Functions: `camelCase` verbs (e.g., `placeOrder`, `closePosition`, `enterCompetition`).

## ğŸ“ API Route Rules

### Pattern

```typescript
export async function GET(req: NextRequest) {
  try {
    await connectToDatabase();
    // ... logic
    return NextResponse.json({ success: true, data });
  } catch (error) {
    console.error("âŒ Route error:", error);
    return NextResponse.json(
      { success: false, error: "Internal server error" },
      { status: 500 }
    );
  }
}
```

### Auth

- Main app: Uses `better-auth` â€” call `getAuth()` from `lib/better-auth/auth.ts` to get the session.
- Admin app: Uses JWT-based auth â€” check via admin middleware (`apps/admin/middleware.ts`).
- Public routes (landing, settings): No auth required â€” document clearly with a comment.

### Response Format

Always return consistent JSON:

```typescript
{ success: true, data: { ... } }           // Success
{ success: false, error: "Human message" }  // Error
```

## ğŸ”„ Mirroring: Main â†” Admin

Many server actions exist in **both** apps:

| Main App | Admin App |
|---|---|
| `lib/actions/trading/order.actions.ts` | `apps/admin/lib/actions/trading/order.actions.ts` |
| `lib/actions/trading/position.actions.ts` | `apps/admin/lib/actions/trading/position.actions.ts` |

**When changing logic in one, check and update the other.**

## ğŸ“ Key API Route Groups

| Path | Purpose |
|---|---|
| `app/api/trading/` | Candles, prices, positions, orders, PnL |
| `app/api/competitions/` | Competition CRUD and entry |
| `app/api/challenges/` | 1v1 challenge management |
| `app/api/user/` | Profile, settings, stats |
| `app/api/wallet/` | Deposits, withdrawals, balance |
| `app/api/nuvei/` & `app/api/stripe/` & `app/api/paddle/` | Payment integrations |
| `app/api/messaging/` | Chat and messaging system |
| `app/api/settings/` | Public app settings (branding, SEO) |
| `app/api/simulator/` | Paper trading simulator |
| `app/api/fraud/` | Fraud detection and device tracking |
| `app/api/kyc/` | KYC verification flow |

## âš ï¸ Common Pitfalls

- **Never** expose internal error details to the client â€” log them server-side, return a generic message.
- **Always** call `connectToDatabase()` â€” don't assume the connection is alive.
- **Rate-limit sensitive endpoints** (login, registration, password reset).
- **Validate all user inputs** â€” never trust client data.
- Use `revalidatePath()` sparingly â€” only when the mutation affects a currently rendered page.
