---
description: Testing rules â€” Vitest patterns, what to test, naming conventions
globs:
  - "**/*.test.ts"
  - "**/*.test.tsx"
  - "**/*.spec.ts"
  - "**/*.spec.tsx"
  - "vitest.config.*"
  - "lib/services/**"
  - "lib/actions/**"
---

# Testing â€” ChartVolt

## ğŸ§ª Framework

- **Vitest** for unit and integration tests.
- **React Testing Library** for component tests (if needed).
- Test files live next to the code they test: `foo.ts` â†’ `foo.test.ts`.
- Run tests: `npm test` or `npx vitest`.

## ğŸ“ What to Test (Priority Order)

### Must Test (Critical Business Logic)
1. **Trading calculations** â€” PnL, margin, pip values, spread calculations (`pnl-calculator.service.ts`).
2. **Order validation** â€” Guard chain logic (market hours, restrictions, balance).
3. **Competition scoring** â€” Rank calculation, ROI formulas, tie-breaking.
4. **XP/Level calculations** â€” `xp-level.service.ts` formulas.
5. **Badge evaluation** â€” `badge-evaluation.service.ts` trigger conditions.
6. **Input validation** â€” All server actions' input checks.
7. **Price normalization** â€” Symbol key format conversions.

### Should Test (Important Logic)
- Candle aggregation â€” timeframe rollup logic.
- Date/time utilities â€” market hours, timezone handling.
- Permission checks â€” role-based access control.
- Fraud scoring â€” suspicion score calculation.

### Don't Test (Framework/Library Code)
- React component rendering (unless complex conditional logic).
- Mongoose model definitions.
- Next.js route handlers (test the underlying service instead).
- Third-party library behavior.

## ğŸ“ Test Structure

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";

describe("calculatePnL", () => {
  // Group by scenario
  describe("long positions", () => {
    it("returns positive PnL when price rises", () => {
      const result = calculatePnL({ direction: "buy", entryPrice: 1.1000, currentPrice: 1.1050, lotSize: 1 });
      expect(result.pnl).toBeGreaterThan(0);
    });

    it("returns negative PnL when price falls", () => {
      const result = calculatePnL({ direction: "buy", entryPrice: 1.1000, currentPrice: 1.0950, lotSize: 1 });
      expect(result.pnl).toBeLessThan(0);
    });
  });

  // Edge cases
  describe("edge cases", () => {
    it("handles zero lot size", () => { ... });
    it("handles NaN input gracefully", () => { ... });
    it("handles extremely large values", () => { ... });
  });
});
```

## ğŸ¯ Naming Conventions

- **File names**: `[module].test.ts` or `[module].spec.ts`
- **Describe blocks**: Use the function/module name.
- **It blocks**: Start with a verb: "returns", "throws", "handles", "prevents", "calculates".
- **Test data**: Use realistic values from the trading domain (e.g., real forex pair prices).

## ğŸ”§ Mocking

```typescript
// Mock MongoDB â€” use in-memory or vi.mock
vi.mock("@/database/mongoose", () => ({
  connectToDatabase: vi.fn(),
}));

// Mock external services
vi.mock("@/lib/services/redis.service", () => ({
  getRedisClient: vi.fn(() => null), // Simulate Redis down
}));

// Mock auth session
vi.mock("@/lib/better-auth/auth", () => ({
  getAuth: vi.fn(() => ({
    api: {
      getSession: vi.fn(() => ({ user: { id: "test-user-id", role: "user" } })),
    },
  })),
}));
```

## âš ï¸ Anti-Patterns

- **Don't test implementation details** â€” test behavior, not internal state.
- **Don't write flaky tests** â€” no `setTimeout`, no real network calls.
- **Don't over-mock** â€” if you mock everything, you're testing the mocks.
- **Don't ignore edge cases** â€” NaN, undefined, empty strings, negative numbers, huge numbers.
- **Don't write tests after bugs** without also writing the fix â€” regression tests are valuable.

## ğŸƒ Running Tests

```bash
# Run all tests
npx vitest

# Run specific file
npx vitest pnl-calculator

# Run in watch mode
npx vitest --watch

# Run with coverage
npx vitest --coverage
```
