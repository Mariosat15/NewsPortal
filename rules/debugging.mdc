---
alwaysApply: true
description: Debugging rules for ChartVolt â€” tracing errors, logging, profiling, and issue isolation
---

# Debugging â€” ChartVolt

## ğŸ” Before Debugging

1. **Reproduce first.** Never guess â€” confirm the bug is reproducible and identify the exact trigger.
2. **Read the error message and stack trace fully** before looking at code.
3. **Identify which process** the bug lives in:
   - `next dev` â€” Main Next.js app (port 3000)
   - `apps/admin` â€” Admin Next.js app (separate process)
   - `worker/index.ts` â€” Agenda-based background worker (`IS_WORKER=true`)
   - `websocket-server/index.ts` â€” WS server for real-time messaging (port 3003)
   - `api-server/index.ts` â€” Standalone Express API server

## ğŸ§µ Error Handling Patterns

- **Server Actions** (`lib/actions/`) return `{ success: boolean; error?: string; message?: string }` â€” they do **NOT** throw.
  - // Reason: Next.js strips thrown error messages in production builds.
  - When adding new server actions, always follow this pattern.
- **Frontend** displays errors via `toast.error()` from the `sonner` library.
- Generic fallback: `"Something went wrong. Please contact support."` â€” always include this.

## ğŸ› ï¸ Debugging Checklist

1. **Server-side errors:** Check the terminal running the process (Next.js, worker, WS server).
2. **Client-side errors:** Check the browser DevTools Console and Network tab.
3. **Database errors:** Look for `ğŸ¢ SLOW QUERY` warnings in logs (`database/mongoose.ts` slow query profiler, threshold: 500ms).
4. **Price feed issues:** Check `price-health-monitor.service.ts` â€” it tracks connection status and price staleness.
5. **Redis issues:** Redis is optional. Check `redisDisabled` flag in `lib/services/redis.service.ts`. If Redis is down, the app should still work (graceful degradation).
6. **WebSocket issues:** Check Massive.com WS state in `websocket-price-streamer.ts` â€” look for `reconnectAttempts` and the `on("close")` / `on("error")` handlers.

## ğŸ§ª Common Bug Sources

| Symptom | Likely Cause | Where to Look |
|---|---|---|
| "An error occurred in Server Components render" | Server action is throwing instead of returning | `lib/actions/trading/*.ts` |
| Chart frozen / "Waiting for price data" | Price key mismatch (`EUR/USD` vs `EURUSD`) or WebSocket disconnect | `contexts/PriceProvider.tsx`, `websocket-price-streamer.ts` |
| Stale prices after deploy | Worker/secondary server not receiving Redis relay | `redis.service.ts`, `startRedisPriceRelay()` |
| Missing candles for a timeframe | Higher-TF cache not seeded after restart | `seedHigherTimeframeCaches()` in streamer |
| Position PnL showing NaN | Spread or pip value lookup failed | `pnl-calculator.service.ts`, `FOREX_PAIRS` map |
| Trade not executing | Market hours, user restriction, margin, or competition status check failed | `order.actions.ts` â€” follow the guard chain |

## ğŸ“‹ Logging Standards

- Use `console.warn("âš ï¸ ...")` for recoverable issues (retries, fallbacks).
- Use `console.error("âŒ ...")` for unrecoverable errors.
- Use `console.log("ğŸ“Š/ğŸ“¡/ğŸ”„ ...")` with emoji prefixes for system lifecycle events.
- **Never** leave `console.log` debug statements in committed code â€” remove them after debugging.

## ğŸ” Retry & Fallback Awareness

- MongoDB connection: 3 retries with 1s delay (`database/mongoose.ts`).
- `safeDbOperation()`: Generic retry wrapper with timeout â€” use for any risky DB call.
- Price fetching fallback chain: WS cache â†’ in-memory â†’ Redis â†’ MongoDB â†’ REST API.
- Redis failure: Graceful â€” app continues without caching.

## ğŸ› When Fixing Bugs

- Fix the **root cause**, not the symptom.
- If the bug is in a server action, check **both** `lib/actions/` and `apps/admin/lib/actions/` â€” they often mirror each other.
- After fixing, verify the fix works in **production build mode** (`next build && next start`), not just dev mode.
- Add a `// Reason:` comment explaining why the fix was needed if not obvious.
