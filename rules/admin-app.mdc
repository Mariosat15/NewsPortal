---
globs: apps/admin/**
description: Admin panel application rules for ChartVolt
---

# Admin Panel â€” ChartVolt

## ğŸ—ï¸ Architecture Overview

- **Location:** `apps/admin/` â€” a **separate** Next.js application.
- **Port:** Runs on a different port than the main app (typically 3001).
- **Auth:** JWT-based admin authentication (different from main app's `better-auth`).
- **Shared models:** Admin has its **own copy** of database models in `apps/admin/database/models/`.

## ğŸ“ Key Structure

```
apps/admin/
â”œâ”€â”€ app/                    # Next.js App Router pages
â”‚   â”œâ”€â”€ api/               # Admin API routes
â”‚   â””â”€â”€ (dashboard)/       # Dashboard pages
â”œâ”€â”€ components/admin/      # Admin UI components
â”œâ”€â”€ database/models/       # Mongoose models (MIRRORED from main app)
â”œâ”€â”€ lib/actions/           # Admin server actions (MIRRORED from main app)
â””â”€â”€ middleware.ts           # JWT auth middleware
```

## ğŸ”„ Model & Action Mirroring (CRITICAL)

The admin app maintains its own copies of:

- `apps/admin/database/models/` â† mirrors â†’ `database/models/`
- `apps/admin/lib/actions/trading/` â† mirrors â†’ `lib/actions/trading/`

**When you change a model or action in one, you MUST update the other.**

Key mirrored files:
- `whitelabel.model.ts` â€” App-wide settings (branding, API keys, SEO)
- `order.actions.ts` â€” Order placement/cancellation
- `position.actions.ts` â€” Position management

## ğŸ“ Admin Panel Sections

| Section | Component | Purpose |
|---|---|---|
| Market Settings | `MarketSettingsSection.tsx` | Per-symbol spreads, leverage, trading hours |
| Market Data | `MarketDataSection.tsx` | Price feed config, Massive.com API key |
| Images / Branding | `ImagesSection.tsx` | Logos, favicons, SEO/OG metadata |
| MDB Cluster | (settings) | MongoDB pool sizes and connection config |
| Competitions | (management) | Create/edit/end competitions |
| Users | (management) | User restrictions, KYC, notes |
| Wallets | (management) | Deposits, withdrawals, balances |
| Fraud | (detection) | Fraud scores, device tracking |

## ğŸ”Œ Admin API Routes

- `apps/admin/app/api/images/route.ts` â€” Branding images + SEO settings (GET/PUT).
- `apps/admin/app/api/market-settings/` â€” Trading symbol configuration.
- `apps/admin/app/api/trading/` â€” Admin trading operations.
- Admin routes use `AdminAuth` middleware â€” not `better-auth`.

## âš ï¸ Rules

1. **Never change admin models without updating main app models** (and vice versa).
2. **Admin-only features** (user bans, competition management, financial reports) must have proper authorization checks.
3. **The admin app runs as a separate PM2 process** with `IS_ADMIN=true` â€” this affects MongoDB pool size allocation.
4. **Settings changes** (spreads, market hours, API keys) stored in WhiteLabel take effect **immediately** â€” no restart required for the main app to pick them up (it re-reads from DB).
5. **Test admin changes** by checking both the admin UI and the main app behavior â€” settings flow: Admin UI â†’ MongoDB â†’ Main App reads on next request.
