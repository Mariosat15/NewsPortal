---
globs: lib/services/websocket-price-streamer*,lib/services/real-forex-prices*,lib/services/redis*,lib/services/tpsl-realtime*,lib/services/price-*,contexts/PriceProvider*,websocket-server/**,hooks/useWebSocket*
description: Real-time data, WebSocket, price streaming, and live updates rules for ChartVolt
---

# Real-Time & Price Streaming â€” ChartVolt

## ğŸ—ï¸ Architecture Overview

```
Massive.com WebSocket (wss://socket.massive.com/forex)
       â”‚
       â–¼
websocket-price-streamer.ts (PRIMARY server only)
       â”‚
       â”œâ”€â”€â†’ priceCache (in-memory Map)
       â”œâ”€â”€â†’ formingCandles (in-memory 1m OHLC aggregation)
       â”œâ”€â”€â†’ higherTFCaches (5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M)
       â”œâ”€â”€â†’ Redis pub/sub (relay to secondary servers)
       â”œâ”€â”€â†’ MongoDB Candle1m / CandleHistorical (completed candles)
       â”œâ”€â”€â†’ tpsl-realtime.service.ts (instant TP/SL checks)
       â””â”€â”€â†’ SSE broadcast to connected browsers
              â”‚
              â–¼
       PriceProvider.tsx (React Context â†’ components)
```

## ğŸ“¡ Price Flow â€” Step by Step

1. **Massive.com WebSocket** sends `C.*` (forex quotes), `CAS.*` (second aggregates), `CA.*` (minute aggregates).
2. **`handleQuoteMessage()`** normalizes the symbol (`EUR-USD` â†’ `EURUSD`), validates bid < ask, applies fixed spread if configured, rounds to 5 decimals.
3. **`updateFormingCandle()`** aggregates quotes into 1-minute OHLC bars using the **BID price**.
4. When a new minute starts, the previous candle is saved to MongoDB (`Candle1m`) and the buffer is reset.
5. **`updateHigherTimeframeCaches()`** rolls 1m candles up into 5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M.
6. When a higher-TF period ends, the candle is saved to MongoDB (`CandleHistorical`) â€” **augmented with stored 1m data** for accuracy after restarts.
7. **Broadcast timer** (every 1s) pushes latest prices + forming candles to connected SSE clients.
8. **`PriceProvider.tsx`** receives SSE events and updates React state for all consuming components.

## ğŸ”Œ Multi-Server Setup

- **Primary server:** Connects to Massive.com WebSocket, aggregates candles, broadcasts via SSE and Redis pub/sub.
- **Secondary servers:** Subscribe to Redis pub/sub (`startRedisPriceRelay()`) and relay to their local SSE clients.
- Determined by `autoInitialize()` which checks a `server` lock document in MongoDB.

## ğŸ“ˆ Price Fetching Priority

When any code calls `fetchRealForexPrices()`:

1. **WebSocket cache** â€” fastest, real-time (~0ms).
2. **In-memory `lastKnownPrices`** â€” fast per-server fallback.
3. **Redis cache** â€” checked on cold start only.
4. **MongoDB `PriceCache`** â€” fallback for worker processes.
5. **Massive.com REST API** â€” slowest, blocking on first load.

## ğŸ•¯ï¸ Candle Data API

- **Endpoint:** `GET /api/trading/candles?symbol=EURUSD&timeframe=1m&limit=300`
- **Source:** Reads from `Candle1m` (for 1m) or `CandleHistorical` (for higher TFs) in MongoDB, then appends the current forming candle from the WebSocket streamer's in-memory cache.
- **Historical backfill:** `forex-historical.service.ts` fetches from Massive.com REST API (`/v2/aggs/ticker/`) for data not yet in MongoDB.

## ğŸ”„ SSE (Server-Sent Events) for Browsers

- The main app broadcasts prices via SSE from the price streamer.
- `PriceProvider.tsx` connects to the SSE endpoint and normalizes incoming price quotes.
- Quotes include: `symbol`, `bid`, `ask`, `mid`, `spread`, `timestamp`.
- The provider recalculates `mid = (bid + ask) / 2` on every update to prevent mid from lagging.

## ğŸ›¡ï¸ Resilience

- **WebSocket reconnect:** Auto-reconnects on close/error with exponential backoff.
- **Redis optional:** If Redis is down, the app continues â€” only multi-server relay is affected.
- **Candle buffer seeding:** On startup, `seedCompletedCandlesBuffer()` and `seedHigherTimeframeCaches()` pre-load recent candles from MongoDB to ensure continuity.
- **Price health monitor:** Tracks per-symbol last update time; alerts if a symbol goes stale.

## âš ï¸ Rules for Modifying Real-Time Code

1. **Never break the candle aggregation pipeline.** Candle integrity is critical â€” incorrect OHLC data affects PnL, charts, and indicators.
2. **Always use BID price** for candle OHLC â€” this is consistent throughout and must not change.
3. **Symbol normalization** must be applied consistently: `EUR-USD` â†’ `EURUSD`, `EUR/USD` â†’ `EURUSD`.
4. **Test with live data** â€” real-time bugs only appear under real market conditions.
5. **The WebSocket streamer is a singleton** â€” never instantiate a second connection.
6. **Changes to the broadcast format** affect every connected browser â€” coordinate carefully.
7. **TP/SL checks** happen on every price tick â€” keep `checkTPSLOnPriceUpdate()` fast (< 5ms).
